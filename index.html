<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Further Adventures of the Event Loop</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/loops.css">

		<style>
      .task1, .task2 {
        background-size: 400% 400%;
        background-image: radial-gradient(circle at left, var(--background-colour), transparent 50%, transparent);
        background-position: bottom right;
        transition: background-position 1s, color 1s;
      }
			.highlighted .task1, .highlighted .task2 {
        background-position: top left;
      }
      .highlighted .task2 {
        color: fuchsia;
      }
      .task1 {
        --background-colour: #444;
      }
			.task2 {
				--background-colour: rgb(170, 230, 238);
      }
			.task2 .hljs-string {
				color: #444;
			}
      .double-headed-arrow {
        width: 3em;
        height: 4em;
        background-color: currentColor;
        position: relative;
        border: 1px solid currentColor;
        margin: 3em;
      }
      .double-headed-arrow::before, .double-headed-arrow::after {
        content: '';
        display: block;
        width: 4em;
        height: 3em;
        border: 3em solid transparent;
        border-bottom-color: currentColor;
        box-sizing: border-box;
        position: absolute;
        left: -50%;
        top: -150%;
      }
      .double-headed-arrow::after {
        transform: rotate(.5turn);
        top: 100%;
      }

      .brontosaurus-js {
        width: 0;
        overflow: hidden;
        display: inline-block;
        transition: width 2s steps(14);
      }
      .brontosaurus .brontosaurus-js {
        width: 14ch;
      }

      .brontosaurus-html {
        height: 0;
        overflow: hidden;
        transition: height 2s 3s;
      }
      .brontosaurus .brontosaurus-html {
        height: 1em;
      }

      .task {
        width: 60vmin;
        height: 80vmin;
        background-color: white;
        border: 2vmin solid black;
        display: flex;
        color: black;
        margin: auto;
        padding: 0;
      }
      .task::before {
        margin: auto;
        content: '{}';
        font-family: 'Courier New', Courier, monospace;
        font-weight: bold;
        overflow: hidden;
        font-size: 30vmin;
      }
      .zone-code {
        width: 58vmin;
        height: 10vmin;
        background-color: #faa;
        border: 1vmin dashed black;
        margin: auto;
        position: absolute;
        bottom: 4vmin;
        display: flex;
      }
      .zone-code::before {
        content: 'detectChanges();';
        margin: auto;
        font-size: 2em;
      }

		</style>
		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
          <div style="display: flex">
            <div style="font-size: 6em; text-align: left; margin: auto; position: relative; font-family: serif; text-shadow: 3px 3px #424f71">
              <div>Angular,</div>
              <div style="padding-left: 1em">The Event Loop,</div>
              <div style="position: absolute; font-size: 4em; top: 1rem; left: -4rem; color: #f0f; z-index: -1; opacity: .6; font-family: cursive; text-shadow: none">&</div>
              <div style="padding-left: 2em">You</div>
            </div>
          </div>
					<div class="twitter">@erinjzimmer</div>
				</section>
				<section>
					<pre><code data-noescape class="js" style="font-size: 4em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);
}
					</code></pre>
				</section>
				<section>
					<div class="text">What's a <code style="font-size: 1.5em" class="variable-name">task</code>?</div>
				</section>
				<section>
					<pre class="tasks"><code data-noescape>
&lt;script&gt;
 <div class="task1">
const foo = bar;
foo.doSomething();

document.body.addEventListener('keydown', (event) => {</div>
<div class="task2"> if (event.key === 'PageDown') {
   location.href = "/#/36";
 }</div>
 <div class="task1">});</div>
&lt;/script&gt;
					</code></pre>
				</section>
				<section>
					<div class="text">What does <code style="font-size: 1.2em">execute(<span class="variable-name">task</span>)</code> do?</div>
				</section>
				<section data-background-image="css/glastonbury.jpg">
					<div class="glastonbury">
						<a class="heading" href="just-task-queue.html">What is a task queue and what's it for?</a>
					</div>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 4em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);
}
					</code></pre>
				</section>
				<section data-background-image="css/mario.jpg">
					<a class="heading" href="simple.html">The Rendering Pipeline</a>
				</section>
				<section>
					<div style="display: flex; justify-content: space-between">
						<div style="font-size: 3em; max-width: 40vw; margin: auto; text-align: left">Long running tasks can make your page run like...</div>
						<img class="border" src="css/unco-cat.gif" />
					</div>
        </section>
        <section>
          <pre><code style="font-size: 4em;">
function veryLongTask() {
  firstPartOfTask();
  setTimeout(restOfTheTask);
}
          </code></pre>
        </section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 3.7em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section>
					<div style="font-size: 2.5em">An <u>event loop</u> has one or more <b>task queues.</b></div>
				</section>
				<section>
						<pre><code>
bool did_work = delegate->DoWork();
if (!keep_running_)
	break;
did_work |= delegate->DoDelayedWork(&delayed_work_time_);
if (!keep_running_)
	break;
if (did_work)
	continue;
did_work = delegate->DoIdleWork();
if (!keep_running_)
	break;
					</code></pre>
				</section>
				<section>
					<a style="font-size: 2.5em;" href="multiple-queues.html">Theoretical browser with multiple task queues</a>
				</section>
				<section>
					<div class="list-container" style="font-size: 1.5em">
						<ul>
							<li class="fragment">Queues can be executed in any order</li>
							<li class="fragment">Tasks in the same queue must be executed in the order they arrived</li>
							<li class="fragment">Tasks from the same source<br> must go in the same queue</li>
						</ul>
					</div>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 3.7em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section data-background-image="css/tiny-horse.jpg">
					<a class="headings microtasks" href="microtasks.html">Microtasks</a>
					<div style="font-size: 1em; color: white; background: rgba(206, 190, 190, 0.3); padding: .5em;" 
					class="demo-link">Image by <a href="https://www.flickr.com/people/9197427@N06">Pete Markham</a></div>
				</section>
				<section class="text">
					<a href="infinite-timeouts.html">Tasks</a>
					<div style="margin: 10px">vs</div>
					<a href="infinite-promises.html" target="_blank" rel="noopener">Microtasks</a>	
				</section>
				<section>
					<pre><code data-noescape class="js" style="font-size: 3.5em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 while (<span class="variable-name">microtaskQueue</span>.hasTasks())
  doMicrotask();

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section data-background-image="css/gallop.jpg">
					<h2 class="gallop">Animation Frame Callback Queue</h2>
				</section>
				<section>
					<pre><code style="text-align: center; font-size: 3.7em;">
requestAnimationFrame(callback);
					</code></pre>
				</section>
				<section>
					<pre><code class="javascript" style="font-size: 3em">
requestAnimationFrame(() => {
  this.browser.classList.remove('slide');

  requestAnimationFrame(() => {
    this.browser.classList.add('slide');
  });
});				
					</code></pre>
				</section>
				<section>
					<pre><code class="javascript" style="font-size: 3em">
this.browser.classList.remove('slide');
this.browser.classList.add('slide');					
					</code></pre>
					<img style="filter: drop-shadow(2px 2px 1px var(--background-start));" src="css/Clippy.png" />
					<a class="demo-link" style="left: 0; right: unset" href="requestAnimationFrame.html">Demo</a>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 2.6em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 while (<span class="variable-name">microtaskQueue</span>.hasTasks()) 
  doMicrotask();

 if (isRepaintTime()) {
  <span class="variable-name">animationTasks</span> = <span class="variable-name">animationQueue</span>.copyTasks();
  for (<span class="variable-name">task</span> in <span class="variable-name">animationTasks</span>) 
   doAnimationTask(<span class="variable-name">task</span>);
		
  repaint();
 }
}
					</code></pre>
				</section>
				<section>
					<div style="font-size: 3.3em; display: flex; align-items: center">
						<div>What does this have to do with </div>
						<img style="width: 2em; margin-left: .5em" src="css/angular-icon.svg" />
						<div>?</div>
					</div>
        </section>
        <section>
          <div id="dinosaurs" style="display: flex; flex-direction: column; align-items: center; position: fixed; top: -10vh">
          <pre><code class="html" style="font-size: 3em" data-noescape>
&lt;ul&gt;
  &lt;li&gt;Tyrannosaurus Rex&lt;/li&gt;
  &lt;li&gt;Velociraptor&lt;/li&gt;
  &lt;li&gt;Triceratops&lt;/li&gt;<div class="brontosaurus-html">  &lt;li&gt;Brontosaurus&lt;/li&gt;</div>&lt;/ul&gt;
          </code></pre>
          <div class="double-headed-arrow"></div>
					<pre><code class="js" data-noescape style="font-size: 3em;">
const dinosaurs = [
  'Tyrannosaurus Rex', 
  'Velociraptor', 
  'Triceratops',
  <div class="brontosaurus-js">'Brontosaurus'</div>
  ];
          </code></pre>
          </div>
        </section>
        <section>
          <div style="font-size: 10em">?</div>
        </section>
        <section>
          <pre style="font-size: 2em"><code>
setState(updatedState);
          </code></pre>
        </section>
        <section>
<pre style="font-size: 2em"><code>
  const app = new Vue({
    name: 'Dr Ellie'
  });
</code></pre>
        </section>
        <section>
<pre style="font-size: 2em"><code>
  Object.defineProperty(
    app, 
    'items',
    { get: () => this._name,
      set: (value) => {
        this._name = value;
        runChangeDetection(); 
      }
    }
  );
</code></pre>
        </section>
        <section>
          <div class="task">
            <div class="fragment zone-code"></div>
          </div>
        </section>
        <section>
          <div style="font-family: 'Courier New'; font-size: 10em">zone.js</div>
        </section>
        <section style="font-size: 3em; text-align: left">
          <p>A Zone is an execution context that persists across async tasks.</p>
          <p>You can think of it as thread-local storage for JavaScript VMs.</p>
          <div>reference</div>
        </section>
        <section style="font-size: 3em; text-align: left">
          <p>A Zone is a mechanism for intercepting and keeping track of work.</p>
          <p class="fragment">
            In its simplest form a Zone allows one to intercept the scheduling and
            calling of asynchronous operations, and execute additional code before
            as well as after the asynchronous code.
          </p>
          <div>reference</div>
        </section>
        <section style="font-size: 1.5em">
            <pre><code>window.setTimeout(callback, delay)</code></pre>
        </section>
        <section style="font-size: 1.5em">
<pre><code>
const nativeTimeout = window.setTimeout;
window.setTimeout = 
  function (callback, delay) {
    nativeTimeout(() => {
      callback();
      someOtherCode();
    }, delay);
  }
</code></pre>
        </section>
        <section style="font-size: 1.5em">
  <pre><code>
const nativeTimeout = window.setTimeout;
window.setTimeout = 
  function (callback, delay) {
    nativeTimeout(() => {
      callback();
      runChangeDetection();
    }, delay);
  }
  </code></pre>
        </section>
        <section>
          <ul>
            <li class="fragment">setTimeout & setInterval</li>
            <li class="fragment">addEventListener & onClick, etc</li>
            <li class="fragment">XMLHttpRequest & FileReader</li>
            <li class="fragment">Promises & requestAnimationFrame</li>
            <li class="fragment">registerElement/IDB/WebSocket/MutationObserver</li>
          </ul>
        </section>
        <section style="font-size: 4em">
          So what?
        </section>
  
        <section>What does Ivy do?</section>
        <section>Is change detection run as part of task or as new task/microtask?</section>
        <section>ZoneJS</section>
        <section>Presumably it wraps global functions and uses onMicrotaskEmpty to deal with Promises?</section>
        <section>ngZone & bootstrapping</section>
        <section>How does this affect me?</section>
        <section>
          <ul>
            <li class="fragment">Running code outside ngZone</li>
            <li class="fragment">Dev mode vs Production mode</li>
            <li class="fragment"vc >Testing</li>
          </ul>
        </section>
        <section>
          If you don't like automatic change detection firing, you can just not
          no ngZone, manual change detection
        </section>
        <section>
          One way binding - changes in parents can cause changes in children, but not vice versa
          In dev mode, Angular always runs the automatic change detection twice
          If it detects any change on the second run, it will throw ExpressionChangedAfterItHasBeenChecked
          This might seem like it's being annoying, but it's actually being helpful
        </section>
        <section>
          In production - only one change detection cycle is run
          If a child component causes a change in a parent, it won't cause an error to be thrown
          But the change also won't be detected, so things won't work as you expect
        </section>
				<section>
          Testing
          Tests don't run in ngZone
          Change detection doesn't work
          This can be a bit of a nuisance (failing test + angry face meme)
        </section>
        <section>
          Actually, it's a good thing, because all your tests run faster
        </section>
        <section>
          But what if you really need change detection - example of test that needs it
        </section>
        <section>
          Angular also provides a testing zone, which works a bit like React and lets you tell it
          when to run change detection
        </section>
        <section>
          enter fixture.detectChanges()
        </section>
        <section>
          also other things you can use? whenStable()?
        </section>
        <section>
          Also testing and async tasks - in terms of the event loop, your test runs as a single task-source
          If you have something asynchronous happening inside your component, it's going to run as a later task
          which potentially could cause your test to fail (or pass when it's not meant to)
        </section>
        <section>
          This is what jasmine's done() function was dealing with - it allowed the test to be broken up into
          multiple tasks and not finish until all tasks had completed
        </section>
        <section>
          Angular gives you a way to do that too - fakeAsync zone
        </section>
        <section>
          fakeAsync lets you control the flow of time within your tests
        </section>
        <section>
          example of test wrapped in fake async
        </section>
        <section>
          flushMicrotaskQueue. hrm can i do an example of this? how does it even work?
        </section>
        <section>
          tick & flush
        </section>
        <section>an understanding of the event loop probably isn't vital, but can definitely help with understanding some of JavaScript's more esoteric behaviour</section>
        <section>fine tune performance by running things outside the ngZone</section>
        <section>ensure your data-binding really is only one-way - be thankful for that error, not cross</section>
        <section>
          all this is especially helpful for testing, where you need to manually trigger a lot of the things 
          that normally happen automatically
          good opportunity to get a better understanding of what's going on in your production app
        </section>
				<section data-background-image="css/roller-coaster.jpg">
					<div class="frosted">
						<div style="margin-bottom: .5em">@erinjzimmer</div>
						<a href="/package.json" style="color: currentColor; font-size: .9em">https://ejzimmer.github.io/event-loop-talk</a>
					</div>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		
		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				controls: false,
				progress: false,
				history: true,
				transition: 'fade',
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
				]
			});
		</script>

		<link rel="import" href="components/event-loop.html">
		<link rel="import" href="components/browser.html">
		<link rel="import" href="components/queues.html">
		<link rel="import" href="components/rendering-pipeline.html">
		<link rel="import" href="components/queue-selector.html">
		<link rel="import" href="components/queue.html">
    <link rel="import" href="components/task-source.html">
    
    <script>
      const task = document.querySelector('.tasks');
      task.addEventListener('click', function () {
        this.classList.add('highlighted');
      });

      const dinosaurs = document.getElementById('dinosaurs');
      dinosaurs.addEventListener('click', function () {
        this.classList.add('brontosaurus');
      })
		</script>
	</body>
</html>
