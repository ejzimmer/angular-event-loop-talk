<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Further Adventures of the Event Loop</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/loops.css">

		<style>
      .task1, .task2 {
        background-size: 400% 400%;
        background-image: radial-gradient(circle at left, var(--background-colour), transparent 50%, transparent);
        background-position: bottom right;
        transition: background-position 1s, color 1s;
      }
			.highlighted .task1, .highlighted .task2 {
        background-position: top left;
      }
      .highlighted .task2 {
        color: fuchsia;
      }
      .task1 {
        --background-colour: #444;
      }
			.task2 {
				--background-colour: rgb(170, 230, 238);
      }
			.task2 .hljs-string {
				color: #444;
			}
		</style>
		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
          <div style="display: flex">
            <div style="font-size: 6em; text-align: left; margin: auto; position: relative; font-family: serif; text-shadow: 3px 3px #424f71">
              <div>Angular,</div>
              <div style="padding-left: 1em">The Event Loop,</div>
              <div style="position: absolute; font-size: 4em; top: 1rem; left: -4rem; color: #f0f; z-index: -1; opacity: .6; font-family: cursive; text-shadow: none">&</div>
              <div style="padding-left: 2em">You</div>
            </div>
          </div>
					<div class="twitter">@erinjzimmer</div>
				</section>
				<section>
					<pre><code data-noescape class="js" style="font-size: 4em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);
}
					</code></pre>
				</section>
				<section>
					<div class="text">What's a <code style="font-size: 1.5em" class="variable-name">task</code>?</div>
				</section>
				<section>
					<pre class="tasks"><code data-noescape>
&lt;script&gt;
 <div class="task1">
const foo = bar;
foo.doSomething();

document.body.addEventListener('keydown', (event) => {</div>
<div class="task2"> if (event.key === 'PageDown') {
   location.href = "/#/36";
 }</div>
 <div class="task1">});</div>
&lt;/script&gt;
					</code></pre>
				</section>
				<section>
					<div class="text">What does <code style="font-size: 1.2em">execute(<span class="variable-name">task</span>)</code> do?</div>
				</section>
				<section data-background-image="css/glastonbury.jpg">
					<div class="glastonbury">
						<a class="heading" href="just-task-queue.html">What is a task queue and what's it for?</a>
					</div>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 4em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);
}
					</code></pre>
				</section>
				<section data-background-image="css/mario.jpg">
					<a class="heading" href="simple.html">The Rendering Pipeline</a>
				</section>
				<section>
					<div style="display: flex; justify-content: space-between">
						<div style="font-size: 3em; max-width: 40vw; margin: auto; text-align: left">Long running tasks can make your page run like...</div>
						<img class="border" src="css/unco-cat.gif" />
					</div>
        </section>
        <section>
          <pre><code style="font-size: 4em;">
function veryLongTask() {
  firstPartOfTask();
  setTimeout(restOfTheTask);
}
          </code></pre>
        </section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 3.7em">
while (true) {
 <span class="variable-name">task</span> = taskQueue.pop();
 execute(<span class="variable-name">task</span>);

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section>
					<div style="font-size: 2.5em">An <u>event loop</u> has one or more <b>task queues.</b></div>
				</section>
				<section>
						<pre><code>
bool did_work = delegate->DoWork();
if (!keep_running_)
	break;
did_work |= delegate->DoDelayedWork(&delayed_work_time_);
if (!keep_running_)
	break;
if (did_work)
	continue;
did_work = delegate->DoIdleWork();
if (!keep_running_)
	break;
					</code></pre>
				</section>
				<section>
					<a style="font-size: 2.5em;" href="multiple-queues.html">Theoretical browser with multiple task queues</a>
				</section>
				<section>
					<div class="list-container" style="font-size: 1.5em">
						<ul>
							<li class="fragment">Queues can be executed in any order</li>
							<li class="fragment">Tasks in the same queue must be executed in the order they arrived</li>
							<li class="fragment">Tasks from the same source<br> must go in the same queue</li>
						</ul>
					</div>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 3.7em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section data-background-image="css/tiny-horse.jpg">
					<a class="headings microtasks" href="microtasks.html">Microtasks</a>
					<div style="font-size: 1em; color: white; background: rgba(206, 190, 190, 0.3); padding: .5em;" 
					class="demo-link">Image by <a href="https://www.flickr.com/people/9197427@N06">Pete Markham</a></div>
				</section>
				<section class="text">
					<a href="infinite-timeouts.html">Tasks</a>
					<div style="margin: 10px">vs</div>
					<a href="infinite-promises.html" target="_blank" rel="noopener">Microtasks</a>	
				</section>
				<section>
					<pre><code data-noescape class="js" style="font-size: 3.5em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 while (<span class="variable-name">microtaskQueue</span>.hasTasks())
  doMicrotask();

 if (isRepaintTime()) repaint();
}
					</code></pre>
				</section>
				<section data-background-image="css/gallop.jpg">
					<h2 class="gallop">Animation Frame Callback Queue</h2>
				</section>
				<section>
					<pre><code style="text-align: center; font-size: 3.7em;">
requestAnimationFrame(callback);
					</code></pre>
				</section>
				<section>
					<pre><code class="javascript" style="font-size: 3em">
requestAnimationFrame(() => {
  this.browser.classList.remove('slide');

  requestAnimationFrame(() => {
    this.browser.classList.add('slide');
  });
});				
					</code></pre>
				</section>
				<section>
					<pre><code class="javascript" style="font-size: 3em">
this.browser.classList.remove('slide');
this.browser.classList.add('slide');					
					</code></pre>
					<img style="filter: drop-shadow(2px 2px 1px var(--background-start));" src="css/Clippy.png" />
					<a class="demo-link" style="left: 0; right: unset" href="requestAnimationFrame.html">Demo</a>
				</section>
				<section>
						<pre><code data-noescape class="js" style="font-size: 2.6em">
while (true) {
 <span class="variable-name">queue</span> = getNextQueue();
 <span class="variable-name">task</span> = <span class="variable-name">queue</span>.pop();
 execute(<span class="variable-name">task</span>);

 while (<span class="variable-name">microtaskQueue</span>.hasTasks()) 
  doMicrotask();

 if (isRepaintTime()) {
  <span class="variable-name">animationTasks</span> = <span class="variable-name">animationQueue</span>.copyTasks();
  for (<span class="variable-name">task</span> in <span class="variable-name">animationTasks</span>) 
   doAnimationTask(<span class="variable-name">task</span>);
		
  repaint();
 }
}
					</code></pre>
				</section>
				<section>
					<div style="font-size: 3.3em">What does this have to do with Angular?</div>
        </section>
        <section>
          <pre><code class="html">
<my-component>
  <ul>
    <li *ngFor="let cat in cats"></li>
  </ul>
</my-component>
          </code></pre>
        </section>
				<section>
					Main uses of framework = link between DOM & js
					Need to know _when_ to update the DOM. 
				</section>
				<section>
					different frameworks do this differently - React, you tell it.
					Vue - getters & setters
				</section>
				<section>
					New Angular (Ivy) - reactive Pipeline - more like Vue?
					current Angular - batch - run change detection after task completes

					ZoneJS - onMicrotaskEmpty event fires automatic change detection
					
					In dev mode, a second change detection cycle runs once the zone is stable
					If this second change detection detects that something has changed in a parent componet, it throws
					ExpressionChangedAfterItHasBeenChecked error
					In prod, this second cycle isn't run, the error isn't thrown, but also the change isn't detected
				</section>
				<section data-background-image="css/roller-coaster.jpg">
					<div class="frosted">
						<div style="margin-bottom: .5em">@erinjzimmer</div>
						<a href="/package.json" style="color: currentColor; font-size: .9em">https://ejzimmer.github.io/event-loop-talk</a>
					</div>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		
		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				controls: false,
				progress: false,
				history: true,
				transition: 'fade',
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
				]
			});
		</script>

		<link rel="import" href="components/event-loop.html">
		<link rel="import" href="components/browser.html">
		<link rel="import" href="components/queues.html">
		<link rel="import" href="components/rendering-pipeline.html">
		<link rel="import" href="components/queue-selector.html">
		<link rel="import" href="components/queue.html">
    <link rel="import" href="components/task-source.html">
    
    <script>
      const task = document.querySelector('.tasks');
      task.addEventListener('click', function () {
        this.classList.add('highlighted');
      });
      document.body.addEventListener('keydown', (event) => {
        console.log(event.key);
			});
		</script>
	</body>
</html>
